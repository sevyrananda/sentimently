{% extends "layouts.html" %}

{% block content %}
<div class="container">
    <h2>Scraping Data</h2>
    <div class="row">
        <div class="col">
            <div class="card mt-5">
                <div class="card-header bg-primary d-flex justify-content-between align-items-center">
                    <h2 class="mt-1 text-white">Twitter Data Scraping</h2>
                    <div class="form-check form-switch form-switch-lg">
                        <input class="form-check-input" type="checkbox" id="scrapeToggle" style="transform: scale(1.5);">
                        <label class="form-check-label text-white ms-2" for="scrapeToggle">Aktifkan Scraping</label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="result" class="mt-3">
                        <div id="loadingAlert" class="alert alert-info" role="alert" style="display:none;">
                            Loading... Please wait.
                        </div>
                        <div id="successAlert" class="alert alert-success" role="alert" style="display:none;">
                            Scraping data berhasil!
                        </div>
                        <div id="errorAlert" class="alert alert-danger" role="alert" style="display:none;">
                            Error: <span id="errorMessage"></span>
                        </div>
                    </div>

                    <div id="sentimentOverview" class="mt-3">
                        <!-- Overview of sentiment analysis -->
                        <h4>Sentimen Mayoritas Hari Ini</h4>
                        <p id="majoritySentiment">Loading...</p>
                    </div>

                    <div class="table-responsive mt-3" style="overflow-x: auto;">
                        <table id="hasilcekTable" class="table table-striped table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Tanggal</th>
                                    <th>Username</th>
                                    <th>Tweet</th>
                                    <th>Cleansing</th>
                                    <th>Sentimen</th>
                                    <th>Case Folding</th>
                                    <th>Tokenizing</th>
                                    <th>Stopword</th>
                                    <th>Stemming</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>
    let scraping = false;

    document.addEventListener('DOMContentLoaded', function () {
        const scrapeToggle = document.getElementById('scrapeToggle');
        const scrapeLabel = document.querySelector('label[for="scrapeToggle"]');

        // Handle toggle change
        scrapeToggle.addEventListener('change', function () {
            if (this.checked) {
                scrapeLabel.textContent = 'Matikan Scraping';
                startScraping();
            } else {
                scrapeLabel.textContent = 'Aktifkan Scraping';
                stopScraping();
            }
        });

        // On page load, fetch data from database if scraping is not active
        if (!scrapeToggle.checked) {
            fetchDataFromDatabase();
        }
    });

    function startScraping() {
        scraping = true;
        document.getElementById('loadingAlert').style.display = 'block';
        document.getElementById('successAlert').style.display = 'none';
        document.getElementById('errorAlert').style.display = 'none';

        fetch('/do_scrape', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ scrape: true })  // Mengaktifkan scraping
        })
        .then(response => response.json())
        .then(data => {
            if (!scraping) {
                throw new Error('Scraping dibatalkan');
            }

            document.getElementById('loadingAlert').style.display = 'none';

            if (data.error) {
                document.getElementById('errorAlert').style.display = 'block';
                document.getElementById('errorMessage').innerText = data.error;
            } else {
                document.getElementById('successAlert').style.display = 'block';
                const sentimentCounts = data.data.reduce((acc, row) => {
                    acc[row.sentimen] = (acc[row.sentimen] || 0) + 1;
                    return acc;
                }, {});

                const majoritySentiment = Object.keys(sentimentCounts).reduce((a, b) => sentimentCounts[a] > sentimentCounts[b] ? a : b);
                document.getElementById('majoritySentiment').innerText = `Mayoritas sentimen hari ini adalah: ${majoritySentiment}`;

                renderTable(data.data);
            }
        })
        .catch(error => {
            document.getElementById('loadingAlert').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'block';
            document.getElementById('errorMessage').innerText = error.message;
        });
    }

    function stopScraping() {
        scraping = false;
        document.getElementById('loadingAlert').style.display = 'none';
        document.getElementById('successAlert').style.display = 'none';
        document.getElementById('errorAlert').style.display = 'none';

        // Panggil fungsi untuk mengambil data dari database
        fetchDataFromDatabase();
    }

    function fetchDataFromDatabase() {
        fetch('/fetch_data_from_database') // Endpoint yang akan mengambil data dari database
        .then(response => response.json())
        .then(data => {
            renderTable(data);
        })
        .catch(error => {
            console.error('Error fetching data from database:', error);
        });
    }

    function renderTable(data) {
        const tableBody = document.querySelector('#hasilcekTable tbody');
        tableBody.innerHTML = '';

        data.forEach((row, index) => {
            const tr = document.createElement('tr');

            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${row.tgl}</td>
                <td>${row.user}</td>
                <td>${row.tweet}</td>
                <td>${row.clean}</td>
                <td><span class="badge ${row.sentimen === 'Positif' ? 'bg-success' : row.sentimen === 'Netral' ? 'bg-warning' : 'bg-danger'} text-white">${row.sentimen}</span></td>
                <td>${row.casefold}</td>
                <td>${row.tokenize}</td>
                <td>${row.stopword}</td>
                <td>${row.stemming}</td>
            `;

            tableBody.appendChild(tr);
        });
    }
</script>


{% endblock %}
