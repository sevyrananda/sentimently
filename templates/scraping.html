{% extends "layouts.html" %}

{% block content %}
<div class="container">
    <h2>Scraping Data</h2>
    <div class="row">
        <div class="col">
            <div class="card mt-5">
                <div class="card-header bg-primary">
                    <h2 class="mt-1 text-white">Twitter Data Scraping</h2>
                </div>
                <div class="card-body">
                    <form id="scrapeForm" class="mt-3">
                        <div class="row mb-4">
                            <div class="col">
                                <label for="keyword" class="form-label">Keyword</label>
                                <input type="text" id="keyword" name="keyword" class="form-control" required>
                            </div>
                            <div class="col-3">
                                <label for="since_date" class="form-label">Sejak Tanggal</label>
                                <input type="date" id="since_date" name="since_date" class="form-control" value="{{ since_date }}" required>
                            </div>
                            <div class="col-3">
                                <label for="until_date" class="form-label">Sampai Tanggal</label>
                                <input type="date" id="until_date" name="until_date" class="form-control" value="{{ until_date }}" required>
                            </div>
                            <div class="col-2">
                                <label for="limit" class="form-label">Limit</label>
                                <input type="number" id="limit" name="limit" class="form-control" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-outline-primary">Scrape Now</button>
                    </form>

                    <div id="authTokenInput" class="mt-3" style="display:none;">
                        <div class="mb-3">
                            <label for="auth_token" class="form-label">Auth Token</label>
                            <input type="text" placeholder="Masukkan auth token" id="auth_token" name="auth_token" class="form-control" required>
                        </div>
                        <button id="submitToken" class="btn btn-primary">Get Data</button>
                    </div>

                    <div id="result" class="mt-3">
                        <div id="loadingAlert" class="alert alert-info" role="alert" style="display:none;">
                            Loading... Please wait.
                        </div>
                        <div id="successAlert" class="alert alert-success" role="alert" style="display:none;">
                            Scraping data successful!
                        </div>
                        <div id="errorAlert" class="alert alert-danger" role="alert" style="display:none;">
                            Error: <span id="errorMessage"></span>
                        </div>
                    </div>

                    <div class="table-responsive mt-3" style="overflow-x: auto;">
                        <table id="hasilcekTable" class="table table-striped table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Tanggal</th>
                                    <th>Username</th>
                                    <th>Tweet</th>
                                    <th>Cleansing</th>
                                    <th>Case Folding</th>
                                    <th>Tokenizing</th>
                                    <th>Stopword</th>
                                    <th>Stemming</th>
                                    <th>Sentimen</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>
    document.getElementById('submitToken').addEventListener('click', function (event) {
        event.preventDefault(); // Mencegah perilaku bawaan formulir

        var authToken = document.getElementById('auth_token').value;
        var sinceDate = document.getElementById('since_date').value;
        var untilDate = document.getElementById('until_date').value;
        var limit = document.getElementById('limit').value;
        var keyword = document.getElementById('keyword').value;

        var requestData = {
            auth_token: authToken,
            since_date: sinceDate,
            until_date: untilDate,
            limit: limit,
            keyword: keyword
        };

        // Menampilkan alert loading saat proses scraping berlangsung
        document.getElementById('loadingAlert').style.display = 'block';
        document.getElementById('successAlert').style.display = 'none';
        document.getElementById('errorAlert').style.display = 'none'; // Sembunyikan alert error jika muncul

        fetch('/do_scrape', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            // Menyembunyikan alert loading
            document.getElementById('loadingAlert').style.display = 'none';

            if (data.error) {
                // Menampilkan pesan kesalahan
                document.getElementById('errorAlert').style.display = 'block';
                document.getElementById('errorMessage').innerText = data.error;
            } else {
                document.getElementById('result').style.display = 'block';

                // Menampilkan alert sukses setelah scraping selesai
                document.getElementById('successAlert').style.display = 'block';

                // Menampilkan data dalam tabel
                const tableBody = document.querySelector('#hasilcekTable tbody');
                tableBody.innerHTML = '';

                data.data.forEach((row, index) => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${row.tgl}</td>
                        <td>${row.user}</td>
                        <td>${row.tweet}</td>
                        <td>${row.clean}</td>
                        <td>${row.casefold}</td>
                        <td>${row.tokenize}</td>
                        <td>${row.stopword}</td>
                        <td>${row.stemming}</td>
                        <td><span class="badge ${row.sentimen === 'Positif' ? 'bg-success' : row.sentimen === 'Netral' ? 'bg-warning' : 'bg-danger'} text-white">${row.sentimen}</span></td>
                    `;

                    tableBody.appendChild(tr);
                });
            }
        })
        .catch(error => {
            // Menampilkan alert error jika terjadi kesalahan saat scraping
            document.getElementById('loadingAlert').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'block';
            document.getElementById('errorMessage').innerText = error.message;
        });
    });

    // Handle submit form for scraping
    document.getElementById('scrapeForm').addEventListener('submit', function (event) {
        event.preventDefault();
        var formData = new FormData(this);
        fetch('/scrape', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            document.getElementById('authTokenInput').style.display = 'block';
        });
    });
</script>

{% endblock %}
