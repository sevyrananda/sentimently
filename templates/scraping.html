{% extends "layouts.html" %}

{% block content %}
<div class="container">
    <h2>Crawling Data</h2>
    <div class="row">
        <div class="col">
            <div class="card mt-5">
                <div class="card-header bg-primary d-flex justify-content-between align-items-center">
                    <h2 class="mt-1 text-white">Twitter Data Crawling</h2>
                    <div class="form-check form-switch form-switch-lg">
                        <input class="form-check-input" type="checkbox" id="scrapeToggle"
                            style="transform: scale(1.5);">
                        <label class="form-check-label text-white ms-2" for="scrapeToggle">Aktifkan Crawling</label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="result" class="mt-3">
                        <div id="loadingAlert" class="alert alert-info" role="alert" style="display:none;">
                            Loading... Please wait.
                        </div>
                        <div id="successAlert" class="alert alert-success" role="alert" style="display:none;">
                            Crawling data berhasil!
                        </div>
                        <div id="errorAlert" class="alert alert-danger" role="alert" style="display:none;">
                            Error: <span id="errorMessage"></span>
                        </div>
                    </div>

                    <div id="sentimentOverview" class="mt-3">
                        <h4>Sentimen Mayoritas Hari Ini</h4>
                        <p id="majoritySentiment">Loading...</p>
                        <p id="accuracyDisplay"></p>
                    </div>
                    <div id="totalTweet" class="mt-3">
                        <p>Total Tweet yang di Crawling: <span id="totalTweetCount">Loading...</span></p>
                    </div>

                    <div class="table-responsive mt-3" style="overflow-x: auto;">
                        <table id="hasilcekTable" class="table table-striped table-bordered table-hover"
                            style="display: none;">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Tanggal</th>
                                    <th>Username</th>
                                    <th>Tweet</th>
                                    <th>Sentimen</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="mt-3">
    <h2>Hasil Crawling</h2>
    <div class="table-responsive">
        <table id="scrapTable" class="table table-striped table-bordered table-hover">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Tanggal</th>
                    <th>Username</th>
                    <th>Tweet</th>
                    <th>Sentimen</th>
                </tr>
            </thead>
            <tbody>
                {% for data in processed_data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ data.tgl }}</td>
                    <td>{{ data.user }}</td>
                    <td>{{ data.tweet }}</td>
                    <td>
                        <span
                            class="badge {% if data.sentimen == 'positif' %}bg-success{% elif data.sentimen == 'netral' %}bg-warning{% else %}bg-danger{% endif %} text-white">
                            {{ data.sentimen }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/2.0.2/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.0.2/js/dataTables.bootstrap5.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>
    new DataTable('#scrapTable');
    let scraping = false;

    document.addEventListener('DOMContentLoaded', function () {
        const scrapeToggle = document.getElementById('scrapeToggle');
        const scrapeLabel = document.querySelector('label[for="scrapeToggle"]');

        scrapeToggle.addEventListener('change', function () {
            if (this.checked) {
                scrapeLabel.textContent = 'Matikan Scraping';
                startScraping();
            } else {
                scrapeLabel.textContent = 'Aktifkan Scraping';
                stopScraping();
            }
        });

        if (!scrapeToggle.checked) {
            fetchDataFromDatabase();
        }
    });

    function fetchDataFromDatabase() {
        fetch('/fetch_data_from_database')
            .then(response => response.json())
            .then(data => {
                // Kosongkan tabel saat pertama kali halaman dimuat
                clearTable();
                updateSentimentOverview(data);
            })
            .catch(error => {
                console.error('Error fetching data from database:', error);
            });
    }

    function startScraping() {
        scraping = true;
        const loadingAlert = document.getElementById('loadingAlert');
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');

        if (loadingAlert) loadingAlert.style.display = 'block';
        if (successAlert) successAlert.style.display = 'none';
        if (errorAlert) errorAlert.style.display = 'none';

        fetch('/do_scrape', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ scrape: true })
        })
            .then(response => response.json())
            .then(data => {
                if (loadingAlert) loadingAlert.style.display = 'none';
                if (data.error) {
                    if (errorAlert) errorAlert.style.display = 'block';
                    if (errorMessage) errorMessage.innerText = data.error;
                } else if (data.message) {
                    if (successAlert) successAlert.style.display = 'block';
                    renderTable(data.data);
                    updateSentimentOverview(data.data);
                    document.getElementById('hasilcekTable').style.display = 'table';
                    if (data.latestUpdate) {
                        document.getElementById('latestUpdate').innerText = `Terakhir Diperbarui: ${data.latestUpdate}`;
                    }
                }
            })
            .catch(error => {
                if (loadingAlert) loadingAlert.style.display = 'none';
                if (errorAlert) errorAlert.style.display = 'block';
                if (errorMessage) errorMessage.innerText = error.message;
            });
    }


    function stopScraping() {
        scraping = false;
        document.getElementById('loadingAlert').style.display = 'none';
        document.getElementById('successAlert').style.display = 'none';
        document.getElementById('errorAlert').style.display = 'none';
        clearTable();
        fetchDataFromDatabase();
    }

    function updateSentimentOverview(data) {
        if (data.length === 0) {
            document.getElementById('majoritySentiment').innerText = 'Tidak ada data';
            document.getElementById('totalTweetCount').innerText = 0;
            return;
        }

        const sentimentCounts = data.reduce((acc, row) => {
            acc[row.sentimen] = (acc[row.sentimen] || 0) + 1;
            return acc;
        }, {});
        const majoritySentiment = Object.keys(sentimentCounts).reduce((a, b) => sentimentCounts[a] > sentimentCounts[b] ? a : b);

        document.getElementById('majoritySentiment').innerText = `Mayoritas sentimen hari ini adalah: ${majoritySentiment}`;
        document.getElementById('totalTweetCount').innerText = data.length;
    }


    function renderTable(data) {
        const tableBody = document.querySelector('#hasilcekTable tbody');
        tableBody.innerHTML = ''; // Clear previous data

        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${row.tgl}</td>
            <td>${row.user}</td>
            <td>${row.tweet}</td>
            <td><span class="badge ${row.sentimen === 'positif' ? 'bg-success' : row.sentimen === 'netral' ? 'bg-warning' : 'bg-danger'} text-white">${row.sentimen}</span></td>
        `;
            tableBody.appendChild(tr);
        });

        if (data.length > 0) {
            document.getElementById('hasilcekTable').style.display = 'table'; // Show the table if there is data
        } else {
            document.getElementById('hasilcekTable').style.display = 'none'; // Hide the table if there is no data
        }
    }


    function clearTable() {
        const tableBody = document.querySelector('#hasilcekTable tbody');
        tableBody.innerHTML = ''; // Clear the table content
        document.getElementById('hasilcekTable').style.display = 'none'; // Hide the table
    }
</script>

{% endblock %}